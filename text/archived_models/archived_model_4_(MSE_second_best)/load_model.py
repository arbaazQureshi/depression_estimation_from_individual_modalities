import numpy as np

from keras.models import Model, Sequential, load_model
from keras.layers import Dense, CuDNNLSTM, Input, Concatenate, Dropout, Bidirectional, TimeDistributed, Lambda, Flatten
import keras

def load_model(location=None):

	if(location != None):
		model = keras.models.load_model(location)
		print("Loaded the model.")
		return model

	X = Input(shape = (400, 512,))
	X_gender = Input(shape = (1,))

	Y = CuDNNLSTM(200, name = 'lstm_cell', return_sequences = True)(X)
	#print(Y.shape)
	P = TimeDistributed(Dense(40, activation = 'tanh'))(Y)
	alpha = TimeDistributed(Dense(1, activation = 'softmax'))(P)
	#P = Dense(400, activation = 'softmax')(P)

	#print(alpha.shape)

	F = Lambda(lambda x : alpha[:, 0:1]*Y[:, 0:1] +  alpha[:, 1:2]*Y[:, 1:2] +  alpha[:, 2:3]*Y[:, 2:3] +  alpha[:, 3:4]*Y[:, 3:4] +  alpha[:, 4:5]*Y[:, 4:5] +  alpha[:, 5:6]*Y[:, 5:6] +  alpha[:, 6:7]*Y[:, 6:7] +  alpha[:, 7:8]*Y[:, 7:8] +  alpha[:, 8:9]*Y[:, 8:9] +  alpha[:, 9:10]*Y[:, 9:10] +  alpha[:, 10:11]*Y[:, 10:11] +  alpha[:, 11:12]*Y[:, 11:12] +  alpha[:, 12:13]*Y[:, 12:13] +  alpha[:, 13:14]*Y[:, 13:14] +  alpha[:, 14:15]*Y[:, 14:15] +  alpha[:, 15:16]*Y[:, 15:16] +  alpha[:, 16:17]*Y[:, 16:17] +  alpha[:, 17:18]*Y[:, 17:18] +  alpha[:, 18:19]*Y[:, 18:19] +  alpha[:, 19:20]*Y[:, 19:20] +  alpha[:, 20:21]*Y[:, 20:21] +  alpha[:, 21:22]*Y[:, 21:22] +  alpha[:, 22:23]*Y[:, 22:23] +  alpha[:, 23:24]*Y[:, 23:24] +  alpha[:, 24:25]*Y[:, 24:25] +  alpha[:, 25:26]*Y[:, 25:26] +  alpha[:, 26:27]*Y[:, 26:27] +  alpha[:, 27:28]*Y[:, 27:28] +  alpha[:, 28:29]*Y[:, 28:29] +  alpha[:, 29:30]*Y[:, 29:30] +  alpha[:, 30:31]*Y[:, 30:31] +  alpha[:, 31:32]*Y[:, 31:32] +  alpha[:, 32:33]*Y[:, 32:33] +  alpha[:, 33:34]*Y[:, 33:34] +  alpha[:, 34:35]*Y[:, 34:35] +  alpha[:, 35:36]*Y[:, 35:36] +  alpha[:, 36:37]*Y[:, 36:37] +  alpha[:, 37:38]*Y[:, 37:38] +  alpha[:, 38:39]*Y[:, 38:39] +  alpha[:, 39:40]*Y[:, 39:40] +  alpha[:, 40:41]*Y[:, 40:41] +  alpha[:, 41:42]*Y[:, 41:42] +  alpha[:, 42:43]*Y[:, 42:43] +  alpha[:, 43:44]*Y[:, 43:44] +  alpha[:, 44:45]*Y[:, 44:45] +  alpha[:, 45:46]*Y[:, 45:46] +  alpha[:, 46:47]*Y[:, 46:47] +  alpha[:, 47:48]*Y[:, 47:48] +  alpha[:, 48:49]*Y[:, 48:49] +  alpha[:, 49:50]*Y[:, 49:50] +  alpha[:, 50:51]*Y[:, 50:51] +  alpha[:, 51:52]*Y[:, 51:52] +  alpha[:, 52:53]*Y[:, 52:53] +  alpha[:, 53:54]*Y[:, 53:54] +  alpha[:, 54:55]*Y[:, 54:55] +  alpha[:, 55:56]*Y[:, 55:56] +  alpha[:, 56:57]*Y[:, 56:57] +  alpha[:, 57:58]*Y[:, 57:58] +  alpha[:, 58:59]*Y[:, 58:59] +  alpha[:, 59:60]*Y[:, 59:60] +  alpha[:, 60:61]*Y[:, 60:61] +  alpha[:, 61:62]*Y[:, 61:62] +  alpha[:, 62:63]*Y[:, 62:63] +  alpha[:, 63:64]*Y[:, 63:64] +  alpha[:, 64:65]*Y[:, 64:65] +  alpha[:, 65:66]*Y[:, 65:66] +  alpha[:, 66:67]*Y[:, 66:67] +  alpha[:, 67:68]*Y[:, 67:68] +  alpha[:, 68:69]*Y[:, 68:69] +  alpha[:, 69:70]*Y[:, 69:70] +  alpha[:, 70:71]*Y[:, 70:71] +  alpha[:, 71:72]*Y[:, 71:72] +  alpha[:, 72:73]*Y[:, 72:73] +  alpha[:, 73:74]*Y[:, 73:74] +  alpha[:, 74:75]*Y[:, 74:75] +  alpha[:, 75:76]*Y[:, 75:76] +  alpha[:, 76:77]*Y[:, 76:77] +  alpha[:, 77:78]*Y[:, 77:78] +  alpha[:, 78:79]*Y[:, 78:79] +  alpha[:, 79:80]*Y[:, 79:80] +  alpha[:, 80:81]*Y[:, 80:81] +  alpha[:, 81:82]*Y[:, 81:82] +  alpha[:, 82:83]*Y[:, 82:83] +  alpha[:, 83:84]*Y[:, 83:84] +  alpha[:, 84:85]*Y[:, 84:85] +  alpha[:, 85:86]*Y[:, 85:86] +  alpha[:, 86:87]*Y[:, 86:87] +  alpha[:, 87:88]*Y[:, 87:88] +  alpha[:, 88:89]*Y[:, 88:89] +  alpha[:, 89:90]*Y[:, 89:90] +  alpha[:, 90:91]*Y[:, 90:91] +  alpha[:, 91:92]*Y[:, 91:92] +  alpha[:, 92:93]*Y[:, 92:93] +  alpha[:, 93:94]*Y[:, 93:94] +  alpha[:, 94:95]*Y[:, 94:95] +  alpha[:, 95:96]*Y[:, 95:96] +  alpha[:, 96:97]*Y[:, 96:97] +  alpha[:, 97:98]*Y[:, 97:98] +  alpha[:, 98:99]*Y[:, 98:99] +  alpha[:, 99:100]*Y[:, 99:100] +  alpha[:, 100:101]*Y[:, 100:101] +  alpha[:, 101:102]*Y[:, 101:102] +  alpha[:, 102:103]*Y[:, 102:103] +  alpha[:, 103:104]*Y[:, 103:104] +  alpha[:, 104:105]*Y[:, 104:105] +  alpha[:, 105:106]*Y[:, 105:106] +  alpha[:, 106:107]*Y[:, 106:107] +  alpha[:, 107:108]*Y[:, 107:108] +  alpha[:, 108:109]*Y[:, 108:109] +  alpha[:, 109:110]*Y[:, 109:110] +  alpha[:, 110:111]*Y[:, 110:111] +  alpha[:, 111:112]*Y[:, 111:112] +  alpha[:, 112:113]*Y[:, 112:113] +  alpha[:, 113:114]*Y[:, 113:114] +  alpha[:, 114:115]*Y[:, 114:115] +  alpha[:, 115:116]*Y[:, 115:116] +  alpha[:, 116:117]*Y[:, 116:117] +  alpha[:, 117:118]*Y[:, 117:118] +  alpha[:, 118:119]*Y[:, 118:119] +  alpha[:, 119:120]*Y[:, 119:120] +  alpha[:, 120:121]*Y[:, 120:121] +  alpha[:, 121:122]*Y[:, 121:122] +  alpha[:, 122:123]*Y[:, 122:123] +  alpha[:, 123:124]*Y[:, 123:124] +  alpha[:, 124:125]*Y[:, 124:125] +  alpha[:, 125:126]*Y[:, 125:126] +  alpha[:, 126:127]*Y[:, 126:127] +  alpha[:, 127:128]*Y[:, 127:128] +  alpha[:, 128:129]*Y[:, 128:129] +  alpha[:, 129:130]*Y[:, 129:130] +  alpha[:, 130:131]*Y[:, 130:131] +  alpha[:, 131:132]*Y[:, 131:132] +  alpha[:, 132:133]*Y[:, 132:133] +  alpha[:, 133:134]*Y[:, 133:134] +  alpha[:, 134:135]*Y[:, 134:135] +  alpha[:, 135:136]*Y[:, 135:136] +  alpha[:, 136:137]*Y[:, 136:137] +  alpha[:, 137:138]*Y[:, 137:138] +  alpha[:, 138:139]*Y[:, 138:139] +  alpha[:, 139:140]*Y[:, 139:140] +  alpha[:, 140:141]*Y[:, 140:141] +  alpha[:, 141:142]*Y[:, 141:142] +  alpha[:, 142:143]*Y[:, 142:143] +  alpha[:, 143:144]*Y[:, 143:144] +  alpha[:, 144:145]*Y[:, 144:145] +  alpha[:, 145:146]*Y[:, 145:146] +  alpha[:, 146:147]*Y[:, 146:147] +  alpha[:, 147:148]*Y[:, 147:148] +  alpha[:, 148:149]*Y[:, 148:149] +  alpha[:, 149:150]*Y[:, 149:150] +  alpha[:, 150:151]*Y[:, 150:151] +  alpha[:, 151:152]*Y[:, 151:152] +  alpha[:, 152:153]*Y[:, 152:153] +  alpha[:, 153:154]*Y[:, 153:154] +  alpha[:, 154:155]*Y[:, 154:155] +  alpha[:, 155:156]*Y[:, 155:156] +  alpha[:, 156:157]*Y[:, 156:157] +  alpha[:, 157:158]*Y[:, 157:158] +  alpha[:, 158:159]*Y[:, 158:159] +  alpha[:, 159:160]*Y[:, 159:160] +  alpha[:, 160:161]*Y[:, 160:161] +  alpha[:, 161:162]*Y[:, 161:162] +  alpha[:, 162:163]*Y[:, 162:163] +  alpha[:, 163:164]*Y[:, 163:164] +  alpha[:, 164:165]*Y[:, 164:165] +  alpha[:, 165:166]*Y[:, 165:166] +  alpha[:, 166:167]*Y[:, 166:167] +  alpha[:, 167:168]*Y[:, 167:168] +  alpha[:, 168:169]*Y[:, 168:169] +  alpha[:, 169:170]*Y[:, 169:170] +  alpha[:, 170:171]*Y[:, 170:171] +  alpha[:, 171:172]*Y[:, 171:172] +  alpha[:, 172:173]*Y[:, 172:173] +  alpha[:, 173:174]*Y[:, 173:174] +  alpha[:, 174:175]*Y[:, 174:175] +  alpha[:, 175:176]*Y[:, 175:176] +  alpha[:, 176:177]*Y[:, 176:177] +  alpha[:, 177:178]*Y[:, 177:178] +  alpha[:, 178:179]*Y[:, 178:179] +  alpha[:, 179:180]*Y[:, 179:180] +  alpha[:, 180:181]*Y[:, 180:181] +  alpha[:, 181:182]*Y[:, 181:182] +  alpha[:, 182:183]*Y[:, 182:183] +  alpha[:, 183:184]*Y[:, 183:184] +  alpha[:, 184:185]*Y[:, 184:185] +  alpha[:, 185:186]*Y[:, 185:186] +  alpha[:, 186:187]*Y[:, 186:187] +  alpha[:, 187:188]*Y[:, 187:188] +  alpha[:, 188:189]*Y[:, 188:189] +  alpha[:, 189:190]*Y[:, 189:190] +  alpha[:, 190:191]*Y[:, 190:191] +  alpha[:, 191:192]*Y[:, 191:192] +  alpha[:, 192:193]*Y[:, 192:193] +  alpha[:, 193:194]*Y[:, 193:194] +  alpha[:, 194:195]*Y[:, 194:195] +  alpha[:, 195:196]*Y[:, 195:196] +  alpha[:, 196:197]*Y[:, 196:197] +  alpha[:, 197:198]*Y[:, 197:198] +  alpha[:, 198:199]*Y[:, 198:199] +  alpha[:, 199:200]*Y[:, 199:200] +  alpha[:, 200:201]*Y[:, 200:201] +  alpha[:, 201:202]*Y[:, 201:202] +  alpha[:, 202:203]*Y[:, 202:203] +  alpha[:, 203:204]*Y[:, 203:204] +  alpha[:, 204:205]*Y[:, 204:205] +  alpha[:, 205:206]*Y[:, 205:206] +  alpha[:, 206:207]*Y[:, 206:207] +  alpha[:, 207:208]*Y[:, 207:208] +  alpha[:, 208:209]*Y[:, 208:209] +  alpha[:, 209:210]*Y[:, 209:210] +  alpha[:, 210:211]*Y[:, 210:211] +  alpha[:, 211:212]*Y[:, 211:212] +  alpha[:, 212:213]*Y[:, 212:213] +  alpha[:, 213:214]*Y[:, 213:214] +  alpha[:, 214:215]*Y[:, 214:215] +  alpha[:, 215:216]*Y[:, 215:216] +  alpha[:, 216:217]*Y[:, 216:217] +  alpha[:, 217:218]*Y[:, 217:218] +  alpha[:, 218:219]*Y[:, 218:219] +  alpha[:, 219:220]*Y[:, 219:220] +  alpha[:, 220:221]*Y[:, 220:221] +  alpha[:, 221:222]*Y[:, 221:222] +  alpha[:, 222:223]*Y[:, 222:223] +  alpha[:, 223:224]*Y[:, 223:224] +  alpha[:, 224:225]*Y[:, 224:225] +  alpha[:, 225:226]*Y[:, 225:226] +  alpha[:, 226:227]*Y[:, 226:227] +  alpha[:, 227:228]*Y[:, 227:228] +  alpha[:, 228:229]*Y[:, 228:229] +  alpha[:, 229:230]*Y[:, 229:230] +  alpha[:, 230:231]*Y[:, 230:231] +  alpha[:, 231:232]*Y[:, 231:232] +  alpha[:, 232:233]*Y[:, 232:233] +  alpha[:, 233:234]*Y[:, 233:234] +  alpha[:, 234:235]*Y[:, 234:235] +  alpha[:, 235:236]*Y[:, 235:236] +  alpha[:, 236:237]*Y[:, 236:237] +  alpha[:, 237:238]*Y[:, 237:238] +  alpha[:, 238:239]*Y[:, 238:239] +  alpha[:, 239:240]*Y[:, 239:240] +  alpha[:, 240:241]*Y[:, 240:241] +  alpha[:, 241:242]*Y[:, 241:242] +  alpha[:, 242:243]*Y[:, 242:243] +  alpha[:, 243:244]*Y[:, 243:244] +  alpha[:, 244:245]*Y[:, 244:245] +  alpha[:, 245:246]*Y[:, 245:246] +  alpha[:, 246:247]*Y[:, 246:247] +  alpha[:, 247:248]*Y[:, 247:248] +  alpha[:, 248:249]*Y[:, 248:249] +  alpha[:, 249:250]*Y[:, 249:250] +  alpha[:, 250:251]*Y[:, 250:251] +  alpha[:, 251:252]*Y[:, 251:252] +  alpha[:, 252:253]*Y[:, 252:253] +  alpha[:, 253:254]*Y[:, 253:254] +  alpha[:, 254:255]*Y[:, 254:255] +  alpha[:, 255:256]*Y[:, 255:256] +  alpha[:, 256:257]*Y[:, 256:257] +  alpha[:, 257:258]*Y[:, 257:258] +  alpha[:, 258:259]*Y[:, 258:259] +  alpha[:, 259:260]*Y[:, 259:260] +  alpha[:, 260:261]*Y[:, 260:261] +  alpha[:, 261:262]*Y[:, 261:262] +  alpha[:, 262:263]*Y[:, 262:263] +  alpha[:, 263:264]*Y[:, 263:264] +  alpha[:, 264:265]*Y[:, 264:265] +  alpha[:, 265:266]*Y[:, 265:266] +  alpha[:, 266:267]*Y[:, 266:267] +  alpha[:, 267:268]*Y[:, 267:268] +  alpha[:, 268:269]*Y[:, 268:269] +  alpha[:, 269:270]*Y[:, 269:270] +  alpha[:, 270:271]*Y[:, 270:271] +  alpha[:, 271:272]*Y[:, 271:272] +  alpha[:, 272:273]*Y[:, 272:273] +  alpha[:, 273:274]*Y[:, 273:274] +  alpha[:, 274:275]*Y[:, 274:275] +  alpha[:, 275:276]*Y[:, 275:276] +  alpha[:, 276:277]*Y[:, 276:277] +  alpha[:, 277:278]*Y[:, 277:278] +  alpha[:, 278:279]*Y[:, 278:279] +  alpha[:, 279:280]*Y[:, 279:280] +  alpha[:, 280:281]*Y[:, 280:281] +  alpha[:, 281:282]*Y[:, 281:282] +  alpha[:, 282:283]*Y[:, 282:283] +  alpha[:, 283:284]*Y[:, 283:284] +  alpha[:, 284:285]*Y[:, 284:285] +  alpha[:, 285:286]*Y[:, 285:286] +  alpha[:, 286:287]*Y[:, 286:287] +  alpha[:, 287:288]*Y[:, 287:288] +  alpha[:, 288:289]*Y[:, 288:289] +  alpha[:, 289:290]*Y[:, 289:290] +  alpha[:, 290:291]*Y[:, 290:291] +  alpha[:, 291:292]*Y[:, 291:292] +  alpha[:, 292:293]*Y[:, 292:293] +  alpha[:, 293:294]*Y[:, 293:294] +  alpha[:, 294:295]*Y[:, 294:295] +  alpha[:, 295:296]*Y[:, 295:296] +  alpha[:, 296:297]*Y[:, 296:297] +  alpha[:, 297:298]*Y[:, 297:298] +  alpha[:, 298:299]*Y[:, 298:299] +  alpha[:, 299:300]*Y[:, 299:300] +  alpha[:, 300:301]*Y[:, 300:301] +  alpha[:, 301:302]*Y[:, 301:302] +  alpha[:, 302:303]*Y[:, 302:303] +  alpha[:, 303:304]*Y[:, 303:304] +  alpha[:, 304:305]*Y[:, 304:305] +  alpha[:, 305:306]*Y[:, 305:306] +  alpha[:, 306:307]*Y[:, 306:307] +  alpha[:, 307:308]*Y[:, 307:308] +  alpha[:, 308:309]*Y[:, 308:309] +  alpha[:, 309:310]*Y[:, 309:310] +  alpha[:, 310:311]*Y[:, 310:311] +  alpha[:, 311:312]*Y[:, 311:312] +  alpha[:, 312:313]*Y[:, 312:313] +  alpha[:, 313:314]*Y[:, 313:314] +  alpha[:, 314:315]*Y[:, 314:315] +  alpha[:, 315:316]*Y[:, 315:316] +  alpha[:, 316:317]*Y[:, 316:317] +  alpha[:, 317:318]*Y[:, 317:318] +  alpha[:, 318:319]*Y[:, 318:319] +  alpha[:, 319:320]*Y[:, 319:320] +  alpha[:, 320:321]*Y[:, 320:321] +  alpha[:, 321:322]*Y[:, 321:322] +  alpha[:, 322:323]*Y[:, 322:323] +  alpha[:, 323:324]*Y[:, 323:324] +  alpha[:, 324:325]*Y[:, 324:325] +  alpha[:, 325:326]*Y[:, 325:326] +  alpha[:, 326:327]*Y[:, 326:327] +  alpha[:, 327:328]*Y[:, 327:328] +  alpha[:, 328:329]*Y[:, 328:329] +  alpha[:, 329:330]*Y[:, 329:330] +  alpha[:, 330:331]*Y[:, 330:331] +  alpha[:, 331:332]*Y[:, 331:332] +  alpha[:, 332:333]*Y[:, 332:333] +  alpha[:, 333:334]*Y[:, 333:334] +  alpha[:, 334:335]*Y[:, 334:335] +  alpha[:, 335:336]*Y[:, 335:336] +  alpha[:, 336:337]*Y[:, 336:337] +  alpha[:, 337:338]*Y[:, 337:338] +  alpha[:, 338:339]*Y[:, 338:339] +  alpha[:, 339:340]*Y[:, 339:340] +  alpha[:, 340:341]*Y[:, 340:341] +  alpha[:, 341:342]*Y[:, 341:342] +  alpha[:, 342:343]*Y[:, 342:343] +  alpha[:, 343:344]*Y[:, 343:344] +  alpha[:, 344:345]*Y[:, 344:345] +  alpha[:, 345:346]*Y[:, 345:346] +  alpha[:, 346:347]*Y[:, 346:347] +  alpha[:, 347:348]*Y[:, 347:348] +  alpha[:, 348:349]*Y[:, 348:349] +  alpha[:, 349:350]*Y[:, 349:350] +  alpha[:, 350:351]*Y[:, 350:351] +  alpha[:, 351:352]*Y[:, 351:352] +  alpha[:, 352:353]*Y[:, 352:353] +  alpha[:, 353:354]*Y[:, 353:354] +  alpha[:, 354:355]*Y[:, 354:355] +  alpha[:, 355:356]*Y[:, 355:356] +  alpha[:, 356:357]*Y[:, 356:357] +  alpha[:, 357:358]*Y[:, 357:358] +  alpha[:, 358:359]*Y[:, 358:359] +  alpha[:, 359:360]*Y[:, 359:360] +  alpha[:, 360:361]*Y[:, 360:361] +  alpha[:, 361:362]*Y[:, 361:362] +  alpha[:, 362:363]*Y[:, 362:363] +  alpha[:, 363:364]*Y[:, 363:364] +  alpha[:, 364:365]*Y[:, 364:365] +  alpha[:, 365:366]*Y[:, 365:366] +  alpha[:, 366:367]*Y[:, 366:367] +  alpha[:, 367:368]*Y[:, 367:368] +  alpha[:, 368:369]*Y[:, 368:369] +  alpha[:, 369:370]*Y[:, 369:370] +  alpha[:, 370:371]*Y[:, 370:371] +  alpha[:, 371:372]*Y[:, 371:372] +  alpha[:, 372:373]*Y[:, 372:373] +  alpha[:, 373:374]*Y[:, 373:374] +  alpha[:, 374:375]*Y[:, 374:375] +  alpha[:, 375:376]*Y[:, 375:376] +  alpha[:, 376:377]*Y[:, 376:377] +  alpha[:, 377:378]*Y[:, 377:378] +  alpha[:, 378:379]*Y[:, 378:379] +  alpha[:, 379:380]*Y[:, 379:380] +  alpha[:, 380:381]*Y[:, 380:381] +  alpha[:, 381:382]*Y[:, 381:382] +  alpha[:, 382:383]*Y[:, 382:383] +  alpha[:, 383:384]*Y[:, 383:384] +  alpha[:, 384:385]*Y[:, 384:385] +  alpha[:, 385:386]*Y[:, 385:386] +  alpha[:, 386:387]*Y[:, 386:387] +  alpha[:, 387:388]*Y[:, 387:388] +  alpha[:, 388:389]*Y[:, 388:389] +  alpha[:, 389:390]*Y[:, 389:390] +  alpha[:, 390:391]*Y[:, 390:391] +  alpha[:, 391:392]*Y[:, 391:392] +  alpha[:, 392:393]*Y[:, 392:393] +  alpha[:, 393:394]*Y[:, 393:394] +  alpha[:, 394:395]*Y[:, 394:395] +  alpha[:, 395:396]*Y[:, 395:396] +  alpha[:, 396:397]*Y[:, 396:397] +  alpha[:, 397:398]*Y[:, 397:398] +  alpha[:, 398:399]*Y[:, 398:399] +  alpha[:, 399:400]*Y[:, 399:400])(alpha)
	F = Flatten()(F)
	#print(F.shape)

	Y = Dropout(rate = 0.3)(F)

	#Y = Concatenate(axis = -1)([Y, X_gender])

	Y = Dense(60, activation = 'relu')(Y)
	Y = Dropout(rate = 0.3)(Y)
	
	Y = Dense(1, activation = None)(Y)

	model = Model(inputs = [X, X_gender], outputs = Y)

	print("Created a new model.")

	return model


if __name__ == "__main__":
	m = load_model()